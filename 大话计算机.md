## 实模式与保护模式

操作系统固话到 BIOS ROM

CPU 直接从 ROM 读取代码执行 BIOS 就是简化的操作系统

DOS: 单任务操作系统



如何支持多任务同时安全执行:分区式内存管理

运行某任务之前,loader 分析需要的内存大小,把该任务被分配的访存范围地址和长度更新至对应寄存器,修正后跳转执行.

切换任务时,将当前任务运行到的位置保存下来到一张表中,载入其他任务的 PC,栈指针等寄存器,跳转执行.

轮流时间间隔:取决于始终中断频度及调度算法.

分区式内存管理的弊端: 要求内存运行空间必须连续. 然而多任务切换产生内存分区碎片,需要有空闲分区合并机制.




保护模式:

背景:控制用户态代码访存范围: 提供两个寄存器,一个存该范围基址,一个存长度.一旦用户访问越界则报错.

风险: 用户用指令更改此两个寄存器,扩大可访问范围.

方案: 将更改此二指令的命令设置为特权指令. 

方案细节:

- 用户运行时权限位 Ring3
- 操作系统程序特权位 Ring0
- 中断向量指向的程序 Ring0

风险: 用户更改中断向量?




## 8086 分段+实模式 p1071

分段的一个重要原因是为了让缓存命中率更高.

缓存对空间和时间的局部性较高的场景才有更高的命中率,所以把程序中相似相邻的信息集中起来,形成了段.

loader 为用户程序分配好对应的段之后会载入段寄存器值.

一些段寄存器有自己的载入指令.如 lds(Load DS),lss

跳转命令的分类:

- 短跳转: 跳转距离在 -128~127B
- 近跳转: 跳转距离在 -32~32KB
- 长跳转: 跳转目标地址与当前地址处于不同的段中

段跳转只需携带 1B 长度的地址,因为256B地址用 8 位足以描述.类似地,近跳转需要 2B.

